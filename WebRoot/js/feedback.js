(function(win,$){var AQBFeedback={fbContainer:$("#AQBFeedback"),fbItemSelector:".fb-item",fbItemTextSelector:".fb-text",fbItemIcoSelector:".fb-ico",fbItemSuggestionSelector:".fb-suggestion",fbItemQQSelector:".fb-qq",fbSuggestion:{container:".aqb-feedback-suggestion",close:".fb-close",content:".fb-suggestion-content",response:".fb-suggestion-response",attitudes:".fb-attitudes li",tip:".fb-suggestion-tip",timing:".auto-close-tip b",form:'form[name="suggestion"]'},fbSuggestionFormItems:{content:'textarea[name="content"]',email:"email",attitude:"type",iscc:"cc_mail_flag",submit:"submit"},init:function(container){if(container){this.fbContainer=container}var that=this,fbItems=this.fbItems=this.fbContainer.children(this.fbItemSelector),fbItemIcoSelector=this.fbItemIcoSelector,fbItemTextSelector=this.fbItemTextSelector;var ftWidth={max:106,min:36};this.suggestion.init(this);this.fixItemPosition();fbItems.on({mouseenter:function(){var $this=$(this);if($this.hasClass("disabled")){return}$this.addClass("current").children(fbItemTextSelector).stop().animate({left:-ftWidth.max,width:ftWidth.max},250)},mouseleave:function(){$(this).removeClass("current").children(fbItemTextSelector).stop().animate({left:0,width:ftWidth.min},100)}});fbItems.on("click",fbItemTextSelector+","+fbItemIcoSelector,function(){var $this=$(this),item=$this.parent();if(item.hasClass(that.fbItemSuggestionSelector.replace(".",""))){$this.trigger("mouseleave");if($this.hasClass("disabled")){return}win.setTimeout(function(){that.suggestion.show(item)},400)}else{eval($this.attr("command")||$this.siblings().attr("command"))}return false})},fixItemPosition:function(){this.fbItems.eq(0).children(this.fbItemTextSelector).css("top",0)},suggestion:{init:function(parent){var fbSuggestion=parent.fbContainer.find(parent.fbItemSuggestionSelector);this.eles=parent.fbSuggestion;this.formItems=parent.fbSuggestionFormItems;this.fbSuggestion=fbSuggestion;this.getEles();this.chooseAttitudes();this.resetErrorStyle();this.readEmail();this.initPlaceholder();this.submit()},placeholder:{},getEles:function(){var that=this,suggestion=this.fbSuggestion,eles=this.eles,formItems=this.formItems;$.each(eles,function(k,v){that[k+"Ele"]=suggestion.find(v)});this.form={};$.each(formItems,function(k,v){that.form[k]=/\[name=/.test(v)?suggestion.find(v):suggestion.find('input[name="'+v+'"]')});this.placeholder.email=this.form.email.attr("placeholder")},show:function(handler){var that=this;this.initForm();this.containerEle.show();this.fixPosition();this.handler=handler.addClass("disabled");if(this.inited){return}this.closeEle.on("click",function(){that.close()});var timer=null;$(win).on("resize",function(){win.clearTimeout(timer);timer=win.setTimeout(function(){that.fixPosition()},500)});this.inited=true},initForm:function(){var form=this.form,email=form.email,emailPlaceholder=this.placeholder.email;this.attitudesEle.eq(0).trigger("click");form.content.val("");if(!this.isExistEmail){email.val(emailPlaceholder).addClass("fb-placeholder")}this.responseEle.hide();this.tipEle.show();this.contentEle.show()},close:function(){this.containerEle.hide();this.handler.removeClass("disabled")},autoClose:function(){var that=this,t=3,timing=this.timingEle.html(t);var timer=win.setInterval(function(){timing.html(--t);if(t===0){win.clearInterval(timer);that.close()}},1000)},fixPosition:function(){var container=this.containerEle,height=335,offset=0,winHeight=$(win).height();if(container.filter(":hidden").size()===1||this.winHeight===winHeight){return}offset=container.offset().top+height-winHeight+Math.abs(parseInt(container.css("top")));offset=offset>0?-offset:0;container.animate({top:offset},100);this.winHeight=winHeight},chooseAttitudes:function(){var that=this,$this=null,attitudes=this.attitudesEle;attitudes.on("click",function(){$this=$(this);attitudes.removeClass("fb-selected");$this.addClass("fb-selected");that.form.attitude.val($this.attr("value"))});attitudes.eq(0).trigger("click")},resetErrorStyle:function(){var form=this.form;form.content.on("click keydown",function(){$(this).removeClass("error")});form.email.on("click keydown",function(){$(this).removeClass("error")})},readEmail:function(){var email="",p=-1,cookies=document.cookie;p=cookies.indexOf("__userEmail");if(p===-1){return}email=cookies.substr(p);p=email.indexOf(";");if(p!==-1){email=email.substr(0,p)}email=unescape(email.substr(email.indexOf("=")+1));if(!(/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(email))){return}this.form.email.val(email);this.isExistEmail=true},submit:function(){var that=this;this.form.submit.on("click",function(){if(!that.validate()){that.request()}})},request:function(){var that=this,url=this.formEle.attr("action"),requestData=this.formEle.serialize();$.ajax({type:"POST",url:url,data:requestData,dataType:"JSON",success:function(response){that.completeSubmit(response)},error:function(){}})},validate:function(){var form=this.form,content=form.content,email=form.email,emailPlaceholder=this.placeholder.email,emailVal=email.val();var emailReg=/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/,hasError=false,isFcous=false;if(!/\S/.test(content.val())){content.addClass("error").trigger("focus");isFcous=true;hasError=true}else{content.removeClass("error")}if(/\S/.test(emailVal)&&!emailReg.test(emailVal)&&(emailVal!==emailPlaceholder)){email.addClass("error");hasError=true;if(!isFcous){email.trigger("focus")}}else{email.removeClass("error")}if(!hasError&&(emailVal===emailPlaceholder)){email.val("")}return hasError},initPlaceholder:function(input,val){var email=this.form.email,emailPlaceholder=this.placeholder.email;if(email.val()===emailPlaceholder){email.addClass("fb-placeholder")}email.on("keydown blur",function(e){if((email.val().length===0)&&(e.type==="blur")){email.val(emailPlaceholder).addClass("fb-placeholder")}else{email.removeClass("fb-placeholder")}});email.on("focus",function(){if(email.val()===emailPlaceholder){email.val("")}})},completeSubmit:function(){var that=this;this.tipEle.hide();this.contentEle.hide();this.responseEle.show();this.autoClose()}}};$(function(){$.get("/feedback.html",function(response){$("body").append(response);var _t=win.setInterval(function(){var fb=$("#AQBFeedback");if(fb.size()===1){AQBFeedback.init(fb);win.clearInterval(_t)}},200)})})})(window,window.jQueryFeedback||jQuery);